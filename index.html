<!DOCTYPE html>
<html lang="en">

<head>
    <script>
        (function () {
            var theme = localStorage.getItem('radioAppTheme');
            if (theme === 'dark') {
                document.documentElement.style.backgroundColor = '#0F0F0F';
            } else {
                document.documentElement.style.backgroundColor = '#FFFBFE';
            }
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radio Wave</title>
    <link rel="manifest" href="./manifest_json.json">
    <meta name="theme-color" content="#6750A4">
    <meta name="description" content="Material Design 3 Radio Player">
    <link rel="apple-touch-icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%236750A4'/><circle cx='50' cy='50' r='30' fill='white'/><circle cx='50' cy='50' r='15' fill='%236750A4'/></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">
    <style>
        :root {
            /* Light theme */
            --md-sys-color-primary: #6750A4;
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-primary-container: #EADDFF;
            --md-sys-color-on-primary-container: #21005D;
            --md-sys-color-secondary: #625B71;
            --md-sys-color-on-secondary: #FFFFFF;
            --md-sys-color-secondary-container: #E8DEF8;
            --md-sys-color-on-secondary-container: #1D192B;
            --md-sys-color-tertiary: #7D5260;
            --md-sys-color-on-tertiary: #FFFFFF;
            --md-sys-color-tertiary-container: #FFD8E4;
            --md-sys-color-on-tertiary-container: #31111D;
            --md-sys-color-error: #BA1A1A;
            --md-sys-color-on-error: #FFFFFF;
            --md-sys-color-error-container: #FFDAD6;
            --md-sys-color-on-error-container: #410002;
            --md-sys-color-background: #FFFBFE;
            --md-sys-color-on-background: #1C1B1F;
            --md-sys-color-surface: #FFFBFE;
            --md-sys-color-on-surface: #1C1B1F;
            --md-sys-color-surface-variant: #E7E0EC;
            --md-sys-color-on-surface-variant: #49454F;
            --md-sys-color-outline: #79747E;
            --md-sys-color-outline-variant: #CAC4D0;
            --md-sys-color-surface-container-lowest: #FFFFFF;
            --md-sys-color-surface-container-low: #F7F2FA;
            --md-sys-color-surface-container: #F3EDF7;
            --md-sys-color-surface-container-high: #ECE6F0;
            --md-sys-color-surface-container-highest: #E6E0E9;
        }

        [data-theme="dark"] {
            --md-sys-color-primary: #D0BCFF;
            --md-sys-color-on-primary: #381E72;
            --md-sys-color-primary-container: #4F378B;
            --md-sys-color-on-primary-container: #EADDFF;
            --md-sys-color-secondary: #CCC2DC;
            --md-sys-color-on-secondary: #332D41;
            --md-sys-color-secondary-container: #4A4458;
            --md-sys-color-on-secondary-container: #E8DEF8;
            --md-sys-color-tertiary: #EFB8C8;
            --md-sys-color-on-tertiary: #492532;
            --md-sys-color-tertiary-container: #633B48;
            --md-sys-color-on-tertiary-container: #FFD8E4;
            --md-sys-color-error: #FFB4AB;
            --md-sys-color-on-error: #690005;
            --md-sys-color-error-container: #93000A;
            --md-sys-color-on-error-container: #FFDAD6;
            --md-sys-color-background: #0F0F0F;
            --md-sys-color-on-background: #E6E1E5;
            --md-sys-color-surface: #0F0F0F;
            --md-sys-color-on-surface: #E6E1E5;
            --md-sys-color-surface-variant: #49454F;
            --md-sys-color-on-surface-variant: #CAC4D0;
            --md-sys-color-outline: #938F99;
            --md-sys-color-outline-variant: #49454F;
            --md-sys-color-surface-container-lowest: #0A0A0A;
            --md-sys-color-surface-container-low: #1D1B20;
            --md-sys-color-surface-container: #211F26;
            --md-sys-color-surface-container-high: #2B2930;
            --md-sys-color-surface-container-highest: #36343B;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            background-color: var(--md-sys-color-background);
        }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
            min-height: 100vh;
            margin: 0;
            padding-bottom: 120px;
            transition: all 0.3s cubic-bezier(0.2, 0.0, 0, 1.0);
        }

        .app-container {
            max-width: 500px;
            margin: 0 auto;
            min-height: 100vh;
            background: var(--md-sys-color-surface);
            position: relative;
        }

        .app-bar {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--md-sys-color-surface);
            padding: 8px 16px 16px;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }

        .app-bar-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .app-title {
            font-size: 28px;
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
            letter-spacing: 0px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-title .material-symbols-rounded {
            font-size: 32px;
            color: var(--md-sys-color-primary);
        }

        .theme-toggle {
            width: 48px;
            height: 48px;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface-variant);
        }

        .theme-toggle:hover {
            background: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-surface);
        }

        .theme-toggle .material-symbols-rounded {
            font-size: 24px;
        }

        .language-selector {
            display: flex;
            background: var(--md-sys-color-surface-container);
            border-radius: 20px;
            padding: 4px;
        }

        .language-btn {
            flex: 1;
            padding: 10px 16px;
            border: none;
            background: transparent;
            color: var(--md-sys-color-on-surface-variant);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
            border-radius: 16px;
            font-family: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .language-btn .material-symbols-rounded {
            font-size: 18px;
        }

        .language-btn.active {
            background: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
        }

        .content {
            padding: 24px 16px;
        }

        .section-title {
            font-size: 22px;
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
            margin-bottom: 16px;
        }

        .stations-container {
            background: var(--md-sys-color-surface-container-low);
            border-radius: 16px;
            overflow: hidden;
        }

        .station-item {
            display: flex;
            align-items: center;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
            position: relative;
        }

        .station-item:last-child {
            border-bottom: none;
        }

        .station-item:hover {
            background: var(--md-sys-color-surface-container);
        }

        .station-item.active {
            background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
        }

        .station-avatar {
            width: 48px;
            height: 48px;
            border-radius: 24px;
            background: var(--md-sys-color-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
            flex-shrink: 0;
        }

        .station-item.active .station-avatar {
            background: var(--md-sys-color-primary);
        }

        .station-avatar .material-symbols-rounded {
            font-size: 24px;
            color: var(--md-sys-color-on-primary);
        }

        .station-details {
            flex: 1;
            min-width: 0;
            margin-right: 8px;
        }

        .station-name {
            font-size: 16px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
            margin-bottom: 4px;
            line-height: 1.3;
        }

        .station-item.active .station-name {
            color: var(--md-sys-color-on-primary-container);
        }

        .station-genre {
            font-size: 14px;
            color: var(--md-sys-color-on-surface-variant);
            line-height: 1.2;
        }

        .station-item.active .station-genre {
            color: var(--md-sys-color-on-primary-container);
        }

        .playing-indicator {
            width: 24px;
            height: 24px;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .station-item.active .playing-indicator {
            display: flex;
        }

        .playing-indicator .material-symbols-rounded {
            font-size: 20px;
            color: var(--md-sys-color-primary);
            animation: pulse 2s infinite;
        }

        .station-item.active .playing-indicator .material-symbols-rounded {
            color: var(--md-sys-color-on-primary-container);
        }

        .favorite-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            color: var(--md-sys-color-on-surface-variant);
            margin-right: 8px;
        }

        .favorite-btn:hover {
            background: var(--md-sys-color-surface-container);
            color: var(--md-sys-color-on-surface);
        }

        .favorite-btn.favorited {
            color: var(--md-sys-color-error);
        }

        .favorite-btn.favorited:hover {
            background: var(--md-sys-color-error-container);
            color: var(--md-sys-color-on-error-container);
        }

        .station-item.active .favorite-btn {
            color: var(--md-sys-color-on-primary-container);
        }

        .station-item.active .favorite-btn.favorited {
            color: var(--md-sys-color-error);
        }

        .favorite-btn .material-symbols-rounded {
            color: var(--md-sys-color-on-surface-variant);
            transition: color 0.2s;
        }

        .favorite-btn.favorited .material-symbols-rounded {
            color: var(--md-sys-color-error);
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .player-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--md-sys-color-surface-container-high);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--md-sys-color-outline-variant);
            z-index: 1000;
        }

        .player-content {
            max-width: 500px;
            margin: 0 auto;
            padding: 16px;
        }

        .now-playing {
            margin-bottom: 16px;
        }

        .now-playing-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .now-playing-label {
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--md-sys-color-on-surface-variant);
        }

        .genre-chip {
            background: var(--md-sys-color-tertiary-container);
            color: var(--md-sys-color-on-tertiary-container);
            padding: 4px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: none;
            margin-left: 4px;
        }

        .genre-chip.visible {
            display: inline-block;
        }

        .genre-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
        }

        .station-title {
            font-size: 18px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
            line-height: 1.3;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
        }

        .current-song {
            font-size: 14px;
            font-weight: 400;
            color: var(--md-sys-color-on-surface-variant);
            line-height: 1.3;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: none;
        }

        .current-song.visible {
            display: block;
        }

        .press-play-message {
            color: var(--md-sys-color-on-surface-variant);
            font-size: 16px;
            font-weight: 400;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .press-play-message .material-symbols-rounded {
            font-size: 20px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {

            0%,
            20%,
            50%,
            80%,
            100% {
                transform: translateY(0);
            }

            40% {
                transform: translateY(-3px);
            }

            60% {
                transform: translateY(-2px);
            }
        }

        .player-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .control-btn {
            width: 48px;
            height: 48px;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--md-sys-color-surface-container);
            color: var(--md-sys-color-on-surface);
        }

        .control-btn:hover:not(:disabled) {
            background: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
        }

        .control-btn:disabled {
            background: var(--md-sys-color-surface-container);
            color: var(--md-sys-color-on-surface-variant);
            opacity: 0.38;
            cursor: not-allowed;
        }

        .control-btn .material-symbols-rounded {
            font-size: 24px;
        }

        .play-pause-btn {
            width: 56px;
            height: 56px;
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border-radius: 28px;
            margin: 0 8px;
        }

        .play-pause-btn:hover {
            background: var(--md-sys-color-primary);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(103, 80, 164, 0.3);
        }

        .play-pause-btn .material-symbols-rounded {
            font-size: 28px;
        }

        .loading-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--md-sys-color-on-surface-variant);
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--md-sys-color-outline);
            border-radius: 50%;
            border-top-color: var(--md-sys-color-primary);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .error-message {
            background: var(--md-sys-color-error-container);
            color: var(--md-sys-color-on-error-container);
            padding: 16px;
            border-radius: 12px;
            font-size: 14px;
            margin: 16px 0;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--md-sys-color-on-surface-variant);
        }

        .empty-state .material-symbols-rounded {
            font-size: 48px;
            color: var(--md-sys-color-outline);
            margin-bottom: 16px;
        }

        .install-prompt {
            background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            padding: 16px;
            border-radius: 12px;
            margin: 16px;
            cursor: pointer;
            border: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
            width: calc(100% - 32px);
            display: none;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-family: inherit;
        }

        .install-prompt:hover {
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(103, 80, 164, 0.3);
        }

        .install-prompt.visible {
            display: flex;
        }

        @media (max-width: 600px) {
            .app-bar {
                padding: 8px 12px 16px;
            }

            .content {
                padding: 16px 12px;
            }

            .player-content {
                padding: 12px;
            }

            .station-item {
                padding: 12px;
            }

            .station-avatar {
                width: 40px;
                height: 40px;
                border-radius: 20px;
                margin-right: 12px;
            }

            .station-avatar .material-symbols-rounded {
                font-size: 20px;
            }

            .control-btn {
                width: 44px;
                height: 44px;
            }

            .play-pause-btn {
                width: 52px;
                height: 52px;
            }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <div class="app-bar">
            <div class="app-bar-content">
                <div class="app-title">
                    <span class="material-symbols-rounded">radio</span>
                    Radio Wave
                </div>
                <button class="theme-toggle" id="themeToggle">
                    <span class="material-symbols-rounded" id="themeIcon">light_mode</span>
                </button>
            </div>
            <div class="language-selector" id="languageSelector">
                <button class="language-btn active" data-lang="malayalam">മലയാളം</button>
                <button class="language-btn" data-lang="english">English</button>
                <button class="language-btn" data-lang="favorites">
                    <span class="material-symbols-rounded">favorite</span>
                </button>
            </div>
        </div>

        <div class="content">
            <div class="section-title" id="sectionTitle">Stations</div>
            <div class="stations-container" id="stationsContainer">
                <div class="empty-state">
                    <span class="material-symbols-rounded">radio</span>
                    <p>Loading stations...</p>
                </div>
            </div>
        </div>

        <div class="error-message" id="errorMessage"></div>

        <button class="install-prompt" id="installPrompt">
            <span class="material-symbols-rounded">install_mobile</span>
            Install Radio Wave
        </button>
    </div>

    <div class="player-bar">
        <div class="player-content">
            <div class="now-playing">
                <div class="now-playing-header">
                    <div class="now-playing-label">Now Playing</div>
                    <div class="genre-chips" id="genreChips"></div>
                </div>
                <div class="station-title" id="stationTitle">
                    <div class="press-play-message">
                        <span class="material-symbols-rounded">play_arrow</span>
                        Press play to begin
                    </div>
                </div>
                <div class="current-song" id="currentSong"></div>
            </div>
            <div class="player-controls">
                <button class="control-btn" id="prevBtn" disabled>
                    <span class="material-symbols-rounded">skip_previous</span>
                </button>
                <button class="play-pause-btn" id="playPauseBtn">
                    <span class="material-symbols-rounded">play_arrow</span>
                </button>
                <button class="control-btn" id="nextBtn" disabled>
                    <span class="material-symbols-rounded">skip_next</span>
                </button>
            </div>
        </div>
    </div>

    <audio id="audioPlayer" preload="none" crossorigin="anonymous"></audio>

    <script>
        class MaterialRadioPlayer {
            constructor() {
                this.audio = document.getElementById('audioPlayer');
                this.stationsContainer = document.getElementById('stationsContainer');
                this.playPauseBtn = document.getElementById('playPauseBtn');
                this.prevBtn = document.getElementById('prevBtn');
                this.nextBtn = document.getElementById('nextBtn');
                this.stationTitle = document.getElementById('stationTitle');
                this.currentSong = document.getElementById('currentSong');
                this.genreChips = document.getElementById('genreChips');
                this.errorMessage = document.getElementById('errorMessage');
                this.installPrompt = document.getElementById('installPrompt');
                this.themeToggle = document.getElementById('themeToggle');
                this.themeIcon = document.getElementById('themeIcon');
                this.languageSelector = document.getElementById('languageSelector');
                this.sectionTitle = document.getElementById('sectionTitle');

                this.stations = [];
                this.currentStation = null;
                this.currentStationIndex = 0;
                this.isPlaying = false;
                this.hasPlayedOnce = false;
                this.selectedLanguage = 'malayalam';
                this.currentGenre = '';
                this.deferredPrompt = null;
                this.statusPollInterval = null;
                this.currentStatusUrl = null;
                this.favorites = this.loadFavorites();
                this.currentView = 'malayalam'; // Track current view: 'malayalam', 'english', 'favorites'

                this.init();
            }

            async init() {
                this.loadTheme();
                this.setupEventListeners();
                this.setupMediaSession();
                this.setupPWA();
                this.setupAudio();
                await this.loadStations('malayalam');
            }

            loadTheme() {
                const savedTheme = localStorage.getItem('radioAppTheme') || 'light';
                this.applyTheme(savedTheme);
            }

            applyTheme(theme) {
                if (theme === 'dark') {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    document.documentElement.style.backgroundColor = '#0F0F0F';
                    this.themeIcon.textContent = 'dark_mode';
                } else {
                    document.documentElement.removeAttribute('data-theme');
                    document.documentElement.style.backgroundColor = '#FFFBFE';
                    this.themeIcon.textContent = 'light_mode';
                }
                localStorage.setItem('radioAppTheme', theme);
            }

            toggleTheme() {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                this.applyTheme(newTheme);
            }

            setupEventListeners() {
                this.themeToggle.addEventListener('click', () => this.toggleTheme());
                this.playPauseBtn.addEventListener('click', () => this.togglePlayPause());
                this.prevBtn.addEventListener('click', () => this.previousStation());
                this.nextBtn.addEventListener('click', () => this.nextStation());
                this.installPrompt.addEventListener('click', () => this.installPWA());

                this.languageSelector.addEventListener('click', (e) => {
                    const button = e.target.closest('.language-btn');
                    if (button) {
                        const buttons = this.languageSelector.querySelectorAll('.language-btn');
                        buttons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');

                        const lang = button.dataset.lang;
                        if (lang === 'favorites') {
                            this.showFavorites();
                        } else {
                            this.selectLanguage(lang);
                        }
                    }
                });

            }

            setupMediaSession() {
                if ('mediaSession' in navigator) {
                    navigator.mediaSession.setActionHandler('play', () => this.play());
                    navigator.mediaSession.setActionHandler('pause', () => this.pause());
                    navigator.mediaSession.setActionHandler('nexttrack', () => this.nextStation());
                    navigator.mediaSession.setActionHandler('previoustrack', () => this.previousStation());
                    navigator.mediaSession.setActionHandler('stop', () => this.pause());
                }
            }

            updateMediaSessionMetadata(currentSong = null) {
                if ('mediaSession' in navigator && this.currentStation) {
                    const title = currentSong || this.currentStation.name;
                    const artist = this.currentGenre || this.currentStation.genre || 'Radio Station';

                    navigator.mediaSession.metadata = new MediaMetadata({
                        title: title,
                        artist: artist,
                        album: 'Radio Wave',
                        artwork: [{
                            src: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><rect width="512" height="512" fill="%236750A4"/><circle cx="256" cy="256" r="150" fill="white"/><circle cx="256" cy="256" r="75" fill="%236750A4"/></svg>',
                            sizes: '512x512',
                            type: 'image/svg+xml'
                        }]
                    });
                    navigator.mediaSession.playbackState = this.isPlaying ? 'playing' : 'paused';
                }
            }

            setupAudio() {
                this.audio.volume = 1.0;

                this.audio.addEventListener('loadstart', () => {
                    if (this.hasPlayedOnce) {
                        this.stationTitle.innerHTML = '<div class="loading-indicator"><div class="spinner"></div>Loading...</div>';
                        this.hideGenreChips();
                        this.hideCurrentSong();
                    }
                    this.clearError();
                });

                this.audio.addEventListener('canplay', () => {
                    if (this.currentStation && this.hasPlayedOnce) {
                        this.stationTitle.textContent = this.currentStation.name;
                    }
                });

                this.audio.addEventListener('play', () => {
                    this.isPlaying = true;
                    this.hasPlayedOnce = true;
                    this.updatePlayButton();
                    this.updatePlayingIndicators();
                    this.updateMediaSessionMetadata();

                    if (this.currentStation) {
                        this.stationTitle.textContent = this.currentStation.name;
                        this.extractMetadata();
                        // Start polling for current song when playback begins
                        this.startStatusPolling();
                    }
                });

                this.audio.addEventListener('pause', () => {
                    this.isPlaying = false;
                    this.updatePlayButton();
                    this.updatePlayingIndicators();
                    this.updateMediaSessionMetadata();
                    // Stop polling when paused
                    this.stopStatusPolling();
                });

                this.audio.addEventListener('error', () => {
                    this.showError('Failed to load radio stream');
                    if (!this.hasPlayedOnce) {
                        this.showPressPlayMessage();
                    } else {
                        this.stationTitle.textContent = 'Error loading station';
                    }
                    this.hideGenreChips();
                    this.hideCurrentSong();
                    this.updatePlayingIndicators();
                    // Stop polling on error
                    this.stopStatusPolling();
                });

                this.audio.addEventListener('ended', () => {
                    setTimeout(() => {
                        if (this.currentStation) this.play();
                    }, 2000);
                });
            }

            async extractMetadata() {
                // Try to extract ICY metadata from stream headers
                try {
                    const response = await fetch(this.currentStation.url, {
                        method: 'HEAD',
                        mode: 'cors'
                    });

                    const icyGenre = response.headers.get('icy-genre');
                    if (icyGenre && icyGenre.trim()) {
                        this.currentGenre = icyGenre.trim();
                        this.showGenreChips(this.currentGenre);
                        this.updateMediaSessionMetadata();
                    } else {
                        this.hideGenreChips();
                    }
                } catch (error) {
                    // Fallback to station genre if ICY metadata not available
                    if (this.currentStation.genre) {
                        this.currentGenre = this.currentStation.genre;
                        this.showGenreChips(this.currentGenre);
                    } else {
                        this.hideGenreChips();
                    }
                }
            }

            showGenreChips(genreString) {
                // Clear existing chips
                this.genreChips.innerHTML = '';

                if (!genreString) {
                    this.currentGenre = '';
                    return;
                }

                // Split by comma and clean up each genre
                const genres = genreString.split(',')
                    .map(genre => genre.trim())
                    .filter(genre => genre.length > 0)
                    .slice(0, 3); // Limit to 3 genres

                if (genres.length > 0) {
                    genres.forEach(genre => {
                        const chip = document.createElement('div');
                        chip.className = 'genre-chip visible';
                        chip.textContent = genre;
                        this.genreChips.appendChild(chip);
                    });

                    this.currentGenre = genres.join(', ');
                }
            }

            hideGenreChips() {
                this.genreChips.innerHTML = '';
                this.currentGenre = '';
            }

            showCurrentSong(song) {
                if (song && song.trim()) {
                    this.currentSong.textContent = song.trim();
                    this.currentSong.classList.add('visible');
                } else {
                    this.hideCurrentSong();
                }
            }

            hideCurrentSong() {
                this.currentSong.classList.remove('visible');
                this.currentSong.textContent = '';
            }

            loadFavorites() {
                try {
                    const saved = localStorage.getItem('radioWaveFavorites');
                    return saved ? JSON.parse(saved) : [];
                } catch (error) {
                    console.log('Error loading favorites:', error);
                    return [];
                }
            }

            saveFavorites() {
                try {
                    localStorage.setItem('radioWaveFavorites', JSON.stringify(this.favorites));
                } catch (error) {
                    console.log('Error saving favorites:', error);
                }
            }

            toggleFavorite(station, stationIndex = null) {
                const stationId = `${station.name}-${station.url}`;
                const existingIndex = this.favorites.findIndex(fav =>
                    `${fav.name}-${fav.url}` === stationId
                );

                if (existingIndex >= 0) {
                    // Remove from favorites
                    this.favorites.splice(existingIndex, 1);
                } else {
                    // Add to favorites
                    this.favorites.push({
                        name: station.name,
                        url: station.url,
                        genre: station.genre,
                        language: this.selectedLanguage
                    });
                }

                this.saveFavorites();

                // Update the heart icon in the UI
                this.updateFavoriteButtons();

                // If we're currently viewing favorites, refresh the list
                if (this.currentView === 'favorites') {
                    this.showFavorites();
                }
            }

            isFavorite(station) {
                const stationId = `${station.name}-${station.url}`;
                return this.favorites.some(fav => `${fav.name}-${fav.url}` === stationId);
            }

            updateFavoriteButtons() {
                const stationItems = this.stationsContainer.querySelectorAll('.station-item');
                stationItems.forEach((item, index) => {
                    const favoriteBtn = item.querySelector('.favorite-btn');
                    const heartIcon = favoriteBtn.querySelector('.material-symbols-rounded');

                    if (this.stations[index] && this.isFavorite(this.stations[index])) {
                        favoriteBtn.classList.add('favorited');
                        heartIcon.textContent = 'favorite';
                    } else {
                        favoriteBtn.classList.remove('favorited');
                        heartIcon.textContent = 'favorite_border';
                    }
                });
            }

            generateStatusUrl(streamUrl) {
                try {
                    const url = new URL(streamUrl);
                    // Common Icecast status URL patterns
                    return `${url.protocol}//${url.host}/status-json.xsl`;
                } catch (error) {
                    return null;
                }
            }

            async fetchCurrentSong() {
                if (!this.currentStation) return;

                // Only try methods that actually work in browsers
                const success = await this.tryStatusEndpoints();

                if (!success) {
                    // If no metadata available, just hide the current song
                    this.hideCurrentSong();
                    // Don't stop polling completely - try again in case metadata becomes available
                    this.scheduleNextPoll();
                }
            }

            async tryStatusEndpoints() {
                if (!this.currentStation) return false;

                try {
                    const baseUrl = new URL(this.currentStation.url);

                    // List of common metadata endpoints that might actually work
                    const endpoints = [
                        // Standard Icecast status endpoints
                        `${baseUrl.protocol}//${baseUrl.host}/status-json.xsl`,
                        `${baseUrl.protocol}//${baseUrl.host}/status.xsl`,

                        // Shoutcast endpoints
                        `${baseUrl.protocol}//${baseUrl.host}/7.html`,
                        `${baseUrl.protocol}//${baseUrl.host}/stats?json=1`,

                        // Alternative common endpoints
                        `${baseUrl.protocol}//${baseUrl.host}/api/nowplaying`,
                        `${baseUrl.protocol}//${baseUrl.host}/nowplaying`,
                        `${baseUrl.protocol}//${baseUrl.host}/np`,
                        `${baseUrl.protocol}//${baseUrl.host}/current`,

                        // Try with different ports commonly used for admin
                        `${baseUrl.protocol}//${baseUrl.hostname}:8000/status-json.xsl`,
                        `${baseUrl.protocol}//${baseUrl.hostname}:8080/status-json.xsl`,
                    ];

                    for (const endpoint of endpoints) {
                        try {
                            console.log(`Trying endpoint: ${endpoint}`);

                            const response = await fetch(endpoint, {
                                method: 'GET',
                                mode: 'cors',
                                cache: 'no-cache',
                                headers: {
                                    'Accept': 'application/json, text/plain, text/html, */*'
                                }
                            });

                            if (response.ok) {
                                const contentType = response.headers.get('content-type') || '';
                                let songTitle = null;

                                if (contentType.includes('application/json') || endpoint.includes('json')) {
                                    try {
                                        const data = await response.json();
                                        console.log('JSON response:', data);

                                        // Try various JSON structures
                                        songTitle = this.extractTitleFromJSON(data);

                                    } catch (jsonError) {
                                        console.log('JSON parse error:', jsonError);
                                        continue;
                                    }
                                } else {
                                    // Try parsing as text/HTML
                                    const text = await response.text();
                                    console.log('Text response preview:', text.substring(0, 200));

                                    if (endpoint.includes('7.html')) {
                                        // Shoutcast 7.html format: comma-separated values
                                        songTitle = this.parseShoutcast7HTML(text);
                                    } else if (text.length < 500 && !text.includes('<html>')) {
                                        // Assume short text response might be the song title
                                        const cleanText = text.trim();
                                        if (cleanText && !cleanText.toLowerCase().includes('error')) {
                                            songTitle = cleanText;
                                        }
                                    }
                                }

                                if (songTitle && songTitle.trim() && songTitle.length < 200) {
                                    console.log('Found song title:', songTitle);
                                    this.showCurrentSong(songTitle.trim());
                                    this.updateMediaSessionMetadata(songTitle.trim());
                                    this.scheduleNextPoll();
                                    return true;
                                }
                            } else {
                                console.log(`Endpoint ${endpoint} returned ${response.status}`);
                            }
                        } catch (error) {
                            console.log(`Error with endpoint ${endpoint}:`, error.message);
                            continue;
                        }
                    }
                } catch (error) {
                    console.log('Error in tryStatusEndpoints:', error);
                }

                return false;
            }

            extractTitleFromJSON(data) {
                // Try various JSON structures commonly used by streaming servers
                const possiblePaths = [
                    // Icecast
                    () => data.icestats?.source?.title,
                    () => Array.isArray(data.icestats?.source) ? data.icestats.source[data.icestats.source.length - 1]?.title : data.icestats?.source?.title,

                    // Generic
                    () => data.title,
                    () => data.song,
                    () => data.current_song,
                    () => data.currentSong,
                    () => data.now_playing,
                    () => data.nowPlaying,
                    () => data.track,
                    () => data.current,

                    // Nested structures
                    () => data.data?.title,
                    () => data.result?.title,
                    () => data.response?.title,
                    () => data.current?.title,
                    () => data.live?.title,

                    // Array structures
                    () => Array.isArray(data) && data.length > 0 ? data[0].title : null,
                    () => data.tracks?.[0]?.title,
                ];

                for (const pathFn of possiblePaths) {
                    try {
                        const title = pathFn();
                        if (title && typeof title === 'string' && title.trim()) {
                            return title;
                        }
                    } catch (e) {
                        continue;
                    }
                }

                return null;
            }

            parseShoutcast7HTML(text) {
                try {
                    // Shoutcast 7.html format is comma-separated values
                    // Usually: currentlisteners,streamstatus,peaklisteners,maxlisteners,uniquelisteners,bitrate,songtitle
                    const parts = text.split(',');
                    if (parts.length >= 7) {
                        const songTitle = parts[6].trim();
                        return songTitle || null;
                    }
                } catch (error) {
                    console.log('Error parsing Shoutcast format:', error);
                }
                return null;
            }

            scheduleNextPoll() {
                if (this.statusPollInterval) {
                    clearTimeout(this.statusPollInterval);
                }
                this.statusPollInterval = setTimeout(() => {
                    if (this.isPlaying && this.currentStation) {
                        this.fetchCurrentSong();
                    }
                }, 5000);
            }

            startStatusPolling() {
                if (!this.currentStation) return;

                // Generate status URL for current station (fallback method)
                this.currentStatusUrl = this.generateStatusUrl(this.currentStation.url);

                // Start fetching immediately - this will try multiple methods
                this.fetchCurrentSong();
            }

            stopStatusPolling() {
                if (this.statusPollInterval) {
                    clearTimeout(this.statusPollInterval);
                    this.statusPollInterval = null;
                }
                this.currentStatusUrl = null;
                this.hideCurrentSong();
            }

            showPressPlayMessage() {
                this.stationTitle.innerHTML = `
                    <div class="press-play-message">
                        <span class="material-symbols-rounded">play_arrow</span>
                        Press play to begin
                    </div>
                `;
            }

            async loadStations(languageKey) {
                this.selectedLanguage = languageKey;
                this.currentView = languageKey;

                // Update section title based on language
                const titleMap = {
                    'malayalam': 'Malayalam Stations',
                    'english': 'English Stations'
                };
                this.sectionTitle.textContent = titleMap[languageKey] || 'Stations';

                try {
                    this.stationsContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="spinner"></div>
                            <p>Loading stations...</p>
                        </div>
                    `;

                    const defaultStations = {
                        'english': [
                            { name: "BBC Radio 1", url: "http://stream.live.vc.bbcmedia.co.uk/bbc_radio_one", genre: "Pop Music" },
                            { name: "NPR News", url: "https://npr-ice.streamguys1.com/live.mp3", genre: "News & Talk" },
                            { name: "Classic FM", url: "http://media-ice.musicradio.com/ClassicFMMP3", genre: "Classical" },
                            { name: "Jazz FM", url: "https://edge-bauerall-01-gos2.sharp-stream.com/jazzfm.mp3", genre: "Jazz" },
                            { name: "Smooth Radio", url: "http://media-ice.musicradio.com/SmoothUKMP3", genre: "Easy Listening" }
                        ],
                        'malayalam': [
                            { name: "AIR Malayalam", url: "http://air.pc.cdn.bitgravity.com/air/live/pbaudio022/playlist.m3u8", genre: "Malayalam Music" },
                            { name: "Radio Mango", url: "http://bcovlive-a.akamaihd.net/1d86dc6e8a174dbf9647fbeee9c0e8b1/ap-south-1/6034685947001/playlist.m3u8", genre: "Malayalam Hits" },
                            { name: "Asianet Radio", url: "http://bcovlive-a.akamaihd.net/1d86dc6e8a174dbf9647fbeee9c0e8b1/ap-south-1/6034685947001/playlist.m3u8", genre: "Entertainment" },
                            { name: "Red FM Kerala", url: "https://redm.redmedia.com:1935/red_tamil/playlist.m3u8", genre: "Malayalam Popular" }
                        ]
                    };

                    let stations;
                    try {
                        const response = await fetch(`stations_${languageKey}.json`);
                        if (response.ok) {
                            stations = await response.json();
                        } else {
                            stations = defaultStations[languageKey] || [];
                        }
                    } catch (error) {
                        stations = defaultStations[languageKey] || [];
                    }

                    this.stations = stations;
                    this.renderStations();
                } catch (error) {
                    console.error('Error loading stations:', error);
                    this.showError('Failed to load radio stations');
                    this.stationsContainer.innerHTML = `
                        <div class="empty-state">
                            <span class="material-symbols-rounded">error</span>
                            <p>Error loading stations</p>
                        </div>
                    `;
                }
            }

            renderStations() {
                if (this.stations.length === 0) {
                    const emptyMessage = this.currentView === 'favorites'
                        ? 'No favorite stations yet'
                        : 'No stations available';

                    this.stationsContainer.innerHTML = `
                        <div class="empty-state">
                            <span class="material-symbols-rounded">${this.currentView === 'favorites' ? 'favorite_border' : 'radio'}</span>
                            <p>${emptyMessage}</p>
                        </div>
                    `;
                    this.prevBtn.disabled = true;
                    this.nextBtn.disabled = true;
                    return;
                }

                this.stationsContainer.innerHTML = '';
                this.stations.forEach((station, index) => {
                    const stationElement = document.createElement('div');
                    stationElement.className = 'station-item';
                    stationElement.dataset.index = index;

                    const isFav = this.isFavorite(station);
                    const heartIcon = isFav ? 'favorite' : 'favorite_border';
                    const heartClass = isFav ? 'favorited' : '';

                    stationElement.innerHTML = `
                        <div class="station-avatar">
                            <span class="material-symbols-rounded">radio</span>
                        </div>
                        <div class="station-details">
                            <div class="station-name">${station.name}</div>
                            <div class="station-genre">${station.genre || 'Music'}</div>
                        </div>
                        <button class="favorite-btn ${heartClass}" data-index="${index}">
                            <span class="material-symbols-rounded">${heartIcon}</span>
                        </button>
                        <div class="playing-indicator">
                            <span class="material-symbols-rounded">graphic_eq</span>
                        </div>
                    `;

                    // Station click handler (excluding favorite button)
                    stationElement.addEventListener('click', (e) => {
                        if (!e.target.closest('.favorite-btn')) {
                            this.selectStation(index, true);
                        }
                    });

                    // Favorite button click handler
                    const favoriteBtn = stationElement.querySelector('.favorite-btn');
                    favoriteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.toggleFavorite(station, index);
                    });

                    this.stationsContainer.appendChild(stationElement);
                });

                this.prevBtn.disabled = false;
                this.nextBtn.disabled = false;

                // Select first station without auto-playing on initial load
                if (!this.hasPlayedOnce && this.currentView !== 'favorites') {
                    this.selectStation(0, false);
                }
            }

            showFavorites() {
                this.currentView = 'favorites';
                this.sectionTitle.textContent = 'Favorite Stations';
                this.stopStatusPolling();

                // Don't change selectedLanguage, keep it for when user goes back
                this.stations = [...this.favorites]; // Copy favorites array
                this.currentStation = null;
                this.currentStationIndex = 0;
                this.hideGenreChips();

                if (!this.hasPlayedOnce) {
                    this.showPressPlayMessage();
                } else {
                    this.stationTitle.textContent = 'Select a favorite station';
                }

                this.prevBtn.disabled = true;
                this.nextBtn.disabled = true;
                this.updatePlayingIndicators();
                this.renderStations();
            }

            async selectLanguage(languageKey) {
                if (languageKey === 'favorites') {
                    this.showFavorites();
                    return;
                }

                const wasPlaying = this.isPlaying;
                this.pause();
                this.currentView = languageKey;
                this.currentStation = null;
                this.currentStationIndex = 0;
                this.hideGenreChips();
                this.stopStatusPolling();

                if (!this.hasPlayedOnce) {
                    this.showPressPlayMessage();
                } else {
                    this.stationTitle.textContent = 'Loading stations...';
                }

                this.prevBtn.disabled = true;
                this.nextBtn.disabled = true;
                this.updatePlayingIndicators();

                await this.loadStations(languageKey);

                // Auto-play first station if user was already listening
                if (this.stations.length > 0 && wasPlaying && this.hasPlayedOnce) {
                    setTimeout(() => {
                        this.selectStation(0, true);
                    }, 300);
                }
            }

            selectStation(index, autoPlay = false) {
                // Stop polling for previous station
                this.stopStatusPolling();

                // Remove active class from all stations
                const allStations = this.stationsContainer.querySelectorAll('.station-item');
                allStations.forEach(station => station.classList.remove('active'));

                // Add active class to selected station
                const selectedStation = this.stationsContainer.querySelector(`[data-index="${index}"]`);
                if (selectedStation) {
                    selectedStation.classList.add('active');
                }

                this.currentStationIndex = index;
                this.currentStation = this.stations[index];
                this.audio.src = this.currentStation.url;
                this.hideGenreChips();
                this.hideCurrentSong();

                if (!this.hasPlayedOnce && !autoPlay) {
                    this.showPressPlayMessage();
                } else if (this.hasPlayedOnce) {
                    this.stationTitle.textContent = this.currentStation.name;
                }

                this.clearError();
                this.updatePlayingIndicators();
                this.updateMediaSessionMetadata();

                if (autoPlay) {
                    this.play();
                } else if (this.isPlaying) {
                    // If we were playing, start polling for the new station
                    setTimeout(() => {
                        this.startStatusPolling();
                    }, 1000); // Give the stream a moment to start
                }
            }

            nextStation() {
                if (this.stations.length === 0) return;
                this.currentStationIndex = (this.currentStationIndex + 1) % this.stations.length;
                this.selectStation(this.currentStationIndex, this.isPlaying);
            }

            previousStation() {
                if (this.stations.length === 0) return;
                this.currentStationIndex = this.currentStationIndex === 0 ?
                    this.stations.length - 1 : this.currentStationIndex - 1;
                this.selectStation(this.currentStationIndex, this.isPlaying);
            }

            togglePlayPause() {
                if (this.isPlaying) {
                    this.pause();
                } else {
                    this.play();
                }
            }

            updatePlayButton() {
                const icon = this.playPauseBtn.querySelector('.material-symbols-rounded');
                icon.textContent = this.isPlaying ? 'pause' : 'play_arrow';
            }

            updatePlayingIndicators() {
                const allStations = this.stationsContainer.querySelectorAll('.station-item');
                allStations.forEach((station, index) => {
                    const indicator = station.querySelector('.playing-indicator');
                    if (index === this.currentStationIndex && this.isPlaying) {
                        station.classList.add('active');
                        // Playing indicator is shown via CSS when station is active
                    } else if (index === this.currentStationIndex) {
                        station.classList.add('active');
                    } else {
                        station.classList.remove('active');
                    }
                });
            }

            async play() {
                if (!this.currentStation) {
                    if (this.stations.length > 0) {
                        this.selectStation(0);
                    }
                    return;
                }

                try {
                    await this.audio.play();
                    this.clearError();
                } catch (error) {
                    this.showError('Failed to play audio. Please try another station.');
                    this.updatePlayingIndicators();
                }
            }

            pause() {
                this.audio.pause();
                this.clearError();
            }

            showError(message) {
                this.errorMessage.textContent = message;
                this.errorMessage.classList.add('show');
                setTimeout(() => this.clearError(), 5000);
            }

            clearError() {
                this.errorMessage.classList.remove('show');
            }

            setupPWA() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('./service-worker.js')
                        .catch(error => console.log('Service Worker registration failed'));
                }

                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    this.deferredPrompt = e;
                    this.installPrompt.classList.add('visible');
                });

                window.addEventListener('appinstalled', () => {
                    this.installPrompt.classList.remove('visible');
                    this.deferredPrompt = null;
                });
            }

            async installPWA() {
                if (!this.deferredPrompt) return;

                this.deferredPrompt.prompt();
                const result = await this.deferredPrompt.userChoice;

                if (result.outcome === 'accepted') {
                    this.installPrompt.classList.remove('visible');
                }

                this.deferredPrompt = null;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new MaterialRadioPlayer();
        });
    </script>
</body>

</html>